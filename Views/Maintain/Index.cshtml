@{
    ViewBag.Title = "Maintain";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var staffs = ViewBag.Staffs as System.Collections.IEnumerable;
    var customers = ViewBag.Customers as System.Collections.IEnumerable;
    var products = ViewBag.Products as System.Collections.IEnumerable;
}

<style>
    body {
        background-color: #eaf3fc;
    }

    .item-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        background: #fff;
        transition: all 0.2s ease-in-out;
    }

        .item-card:hover {
            background: #f9f9f9;
            transform: scale(1.01);
        }

    .item-buttons {
        margin-top: 8px;
        text-align: right;
    }

    .card {
        border: none;
        border-radius: 10px;
        height: 700px;
        display: flex;
        flex-direction: column;
    }

    .card-body {
        flex-grow: 1;
        overflow-y: auto;
    }

    .card-header {
        font-weight: 600;
        text-align: center;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .product-image {
        width: 100px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 12px;
    }

    .fw-bold {
        font-weight: 600;
    }

    .load-more {
        text-align: center;
        margin-top: 10px;
    }

        .load-more a {
            border-radius: 6px;
            color: #007bff;
        }

            .load-more a:hover {
                background-color: #007bff;
                color: #fff;
            }
</style>

<div class="container mt-4">
    <h2 class="text-center mb-4">Maintain</h2>

    @if (TempData["Msg"] != null)
    {
        <div class="alert alert-success text-center">@TempData["Msg"]</div>
    }

    <div class="row g-4 justify-content-center">

        <!-- ================= STAFF ================= -->
        <div class="col-lg-4 col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">Staff:</div>
                <div class="card-body">
                    @foreach (dynamic s in staffs)
                    {
                        string editId = $"editStaffModal-{s.staff_id}";
                        string delId = $"deleteStaffModal-{s.staff_id}";
                        <div class="item-card">
                            <div class="fw-bold">@s.first_name @s.last_name</div>
                            <div class="text-muted small">@s.email</div>
                            <div class="text-muted small">@s.phone</div>
                            <div class="item-buttons">
                                <button class="btn btn-info btn-sm me-1" data-bs-toggle="modal" data-bs-target="#@editId">Edit</button>
                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#@delId">Delete</button>
                            </div>
                        </div>

                        <!-- Edit Staff Modal -->
                        <div class="modal fade" id="@editId" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("UpdateStaff", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header">
                                            <h5 class="modal-title">Edit Staff</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" name="staff_id" value="@s.staff_id" />
                                            <div class="mb-2"><label>First Name</label><input name="first_name" class="form-control" value="@s.first_name" /></div>
                                            <div class="mb-2"><label>Last Name</label><input name="last_name" class="form-control" value="@s.last_name" /></div>
                                            <div class="mb-2"><label>Email</label><input name="email" class="form-control" value="@s.email" /></div>
                                            <div class="mb-2"><label>Phone</label><input name="phone" class="form-control" value="@s.phone" /></div>
                                            <div class="mb-2">
                                                <label>Store</label>
                                                <select name="store_id" class="form-select">
                                                    @foreach (var store in ViewBag.Stores)
                                                    {
                                                        <option value="@store.store_id" @(s.store_id == store.store_id ? "selected" : "")>@store.store_name</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-primary" type="submit">Update</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Delete Staff Modal -->
                        <div class="modal fade" id="@delId" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("DeleteStaff", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header">
                                            <h5 class="modal-title">Delete Staff</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete <strong>@s.first_name @s.last_name</strong>?</p>
                                            <input type="hidden" name="staff_id" value="@s.staff_id" />
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-danger" type="submit">Delete</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="load-more mb-3">
                    <a href="@Url.Action("Index", "Maintain", new { takeStaff = 50, takeCustomers = 10, takeProducts = 10 })"
                       class="btn btn-outline-info btn-sm">Load More Staff</a>
                </div>
            </div>
        </div>

        <!-- ================= CUSTOMERS ================= -->
        <div class="col-lg-4 col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">Customers:</div>
                <div class="card-body">
                    @foreach (dynamic c in customers)
                    {
                        string editId = $"editCustomerModal-{c.customer_id}";
                        string delId = $"deleteCustomerModal-{c.customer_id}";
                        <div class="item-card">
                            <div class="fw-bold">@c.first_name @c.last_name</div>
                            <div class="text-muted small">@c.email</div>
                            <div class="text-muted small">@c.phone</div>
                            <div class="text-muted small">@c.city</div>
                            <div class="item-buttons">
                                <button class="btn btn-info btn-sm me-1" data-bs-toggle="modal" data-bs-target="#@editId">Edit</button>
                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#@delId">Delete</button>
                            </div>
                        </div>

                        <!-- Edit Customer Modal -->
                        <div class="modal fade" id="@editId" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("UpdateCustomer", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header bg-success text-white">
                                            <h5 class="modal-title">Edit Customer</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" name="customer_id" value="@c.customer_id" />
                                            <div class="mb-2"><label>First Name</label><input name="first_name" class="form-control" value="@c.first_name" /></div>
                                            <div class="mb-2"><label>Last Name</label><input name="last_name" class="form-control" value="@c.last_name" /></div>
                                            <div class="mb-2"><label>Email</label><input name="email" type="email" class="form-control" value="@c.email" /></div>
                                            <div class="mb-2"><label>Phone</label><input name="phone" class="form-control" value="@c.phone" /></div>
                                            <div class="mb-2"><label>City</label><input name="city" class="form-control" value="@c.city" /></div>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-primary" type="submit">Update</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Delete Customer Modal -->
                        <div class="modal fade" id="@delId" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("DeleteCustomer", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">Delete Customer</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete <strong>@c.first_name @c.last_name</strong>?</p>
                                            <input type="hidden" name="customer_id" value="@c.customer_id" />
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-danger" type="submit">Delete</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="load-more mb-3">
                    <a href="@Url.Action("Index", "Maintain", new { takeStaff = 10, takeCustomers = 50, takeProducts = 10 })"
                       class="btn btn-outline-info btn-sm">Load More Customers</a>
                </div>
            </div>
        </div>

        <!-- ================= PRODUCTS ================= -->
        <div class="col-lg-4 col-md-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <span>Products:</span>
                        <form method="get" action="@Url.Action("Index","Maintain")" class="d-flex gap-2">
                            <select name="brandFilter" class="form-select form-select-sm">
                                <option value="">All Brands</option>
                                @foreach (string b in ViewBag.Brands)
                                {
                                    <option value="@b" @(b == ViewBag.SelectedBrand ? "selected" : "")>@b</option>
                                }
                            </select>
                            <select name="categoryFilter" class="form-select form-select-sm">
                                <option value="">All Categories</option>
                                @foreach (string c in ViewBag.Categories)
                                {
                                    <option value="@c" @(c == ViewBag.SelectedCategory ? "selected" : "")>@c</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-light btn-sm">Filter</button>
                        </form>
                    </div>
                </div>

                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="fw-bold text-dark">
                            Showing @ViewBag.ProductCount @(ViewBag.ProductCount == 1 ? "product" : "products")
                        </span>
                    </div>

                    @foreach (dynamic p in products)
                    {
                        var images = ViewBag.ImageFiles as IEnumerable<string>;
                        string imageName = null;

                        string brand = (p.brand?.brand_name ?? "").Replace(" ", "_");
                        string productName = (p.product_name ?? "").Replace(" ", "_");

                        imageName = images?.FirstOrDefault(i =>
                            i.Equals(brand, StringComparison.OrdinalIgnoreCase) ||
                            productName.IndexOf(i, StringComparison.OrdinalIgnoreCase) >= 0);

                        string imagePath = !string.IsNullOrEmpty(imageName)
                            ? Url.Content("~/Content/Images/" + imageName + ".jpeg")
                            : "https://via.placeholder.com/110x80?text=No+Image";

                        <div class="item-card d-flex align-items-start">
                            <img src="@imagePath" alt="@p.product_name" class="product-image" />
                            <div class="flex-grow-1 small">
                                <div class="fw-bold">@p.product_name</div>
                                <div class="text-muted">@p.brand.brand_name | @p.category.category_name</div>
                                <div>Model: @p.model_year</div>
                                <div class="fw-bold">R @String.Format("{0:N2}", p.list_price)</div>
                                <div class="item-buttons">
                                    <button class="btn btn-info btn-sm me-1" data-bs-toggle="modal" data-bs-target="#editProductModal-@p.product_id">Edit</button>
                                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteProductModal-@p.product_id">Delete</button>
                                </div>
                            </div>
                        </div>

                        <!-- ✅ Edit Product Modal -->
                        <div class="modal fade" id="editProductModal-@p.product_id" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("UpdateProduct", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header bg-info text-white">
                                            <h5 class="modal-title">Edit Product</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" name="product_id" value="@p.product_id" />

                                            <div class="mb-2">
                                                <label>Product Name</label>
                                                <input name="product_name" class="form-control" value="@p.product_name" required />
                                            </div>

                                            <div class="mb-2">
                                                <label>Model Year</label>
                                                <input name="model_year" type="number" class="form-control" value="@p.model_year" required />
                                            </div>

                                            <div class="mb-2">
                                                <label>List Price</label>
                                                <input name="list_price" type="number" step="0.01" class="form-control" value="@p.list_price" required />
                                            </div>

                                            <!-- ✅ Correct Brand ID dropdown -->
                                            <div class="mb-2">
                                                <label>Brand</label>
                                                <select name="brand_id" class="form-select" required>
                                                    @foreach (var b in ViewBag.BrandList as List<HW03.Models.brand>)
                                                    {
                                                        <option value="@b.brand_id" @(b.brand_id == p.brand_id ? "selected" : "")>
                                                            @b.brand_name
                                                        </option>
                                                    }
                                                </select>
                                            </div>

                                            <!-- ✅ Correct Category ID dropdown -->
                                            <div class="mb-2">
                                                <label>Category</label>
                                                <select name="category_id" class="form-select" required>
                                                    @foreach (var cat in ViewBag.CategoryList as List<HW03.Models.category>)
                                                    {
                                                        <option value="@cat.category_id" @(cat.category_id == p.category_id ? "selected" : "")>
                                                            @cat.category_name
                                                        </option>
                                                    }
                                                </select>
                                            </div>

                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-primary" type="submit">Save Changes</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>


                        <!-- ✅ Delete Product Modal -->
                        <div class="modal fade" id="deleteProductModal-@p.product_id" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    @using (Html.BeginForm("DeleteProduct", "Maintain", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">Delete Product</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete <strong>@p.product_name</strong>?</p>
                                            <input type="hidden" name="product_id" value="@p.product_id" />
                                        </div>
                                        <div class="modal-footer">

                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button class="btn btn-danger" type="submit">Delete</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="load-more mb-3">
                    <a href="@Url.Action("Index", "Maintain", new { takeStaff = 10, takeCustomers = 10, takeProducts = 50 })"
                       class="btn btn-outline-info btn-sm">Load More Products</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .text-center.mb-3 span {
        transition: opacity 0.3s ease-in-out;
    }
</style>
